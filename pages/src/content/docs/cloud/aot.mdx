---
title: AOT ç¼–è¯‘åŸç†ä¸å®è·µ
description: æ·±åº¦è§£æFeatæ¡†æ¶AOTç¼–è¯‘æœºåˆ¶çš„æ ¸å¿ƒåŸç†ä¸å®è·µæ•™ç¨‹
sidebar:
    order: 2
---

import CheckAuthorize from '../../../components/CheckAuthorize.astro'
import Mermaid from '../../../components/Mermaid.astro'
import { TabItem, Tabs, Aside } from "@astrojs/starlight/components";

<CheckAuthorize/>

## AOTç¼–è¯‘æ ¸å¿ƒåŸç†

Featæ¡†æ¶é€šè¿‡AOTï¼ˆAhead-of-Timeï¼‰ç¼–è¯‘æŠ€æœ¯å®ç°é›¶åå°„çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œç›¸æ¯”ä¼ ç»ŸJavaæ¡†æ¶åœ¨è¿è¡Œæ—¶çš„åå°„æ“ä½œï¼ŒFeatåœ¨ç¼–è¯‘æœŸå°±å®Œæˆäº†æ‰€æœ‰çš„ä»£ç ç”Ÿæˆå’Œä¼˜åŒ–å·¥ä½œã€‚

### æ ¸å¿ƒä¼˜åŠ¿

| ç‰¹æ€§ | ä¼ ç»Ÿæ¡†æ¶ | Feat Cloud |
|------|---------|------------|
| **ç¼–è¯‘æœŸä¼˜åŒ–** | è¿è¡Œæ—¶åå°„è§£æ | ç¼–è¯‘æœŸé™æ€ç”Ÿæˆä»£ç  |
| **å¯åŠ¨æ€§èƒ½** | éœ€è¦ç±»æ‰«æå’Œæ³¨è§£è§£æ | ç›´æ¥åŠ è½½é¢„ç”Ÿæˆä»£ç  |
| **å†…å­˜æ•ˆç‡** | è¿è¡Œæ—¶å…ƒæ•°æ®ç¼“å­˜ | ç¼–è¯‘æœŸä¼˜åŒ–ï¼Œå‡å°‘è¿è¡Œæ—¶å¼€é”€ |
| **GraalVMæ”¯æŒ** | éœ€è¦å¤æ‚é…ç½® | åŸç”Ÿå…¼å®¹ |

## æŠ€æœ¯æ¶æ„

Featæ¡†æ¶æä¾›äº†ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š

<Mermaid code={`
graph TD
    A[Featåº”ç”¨å¯åŠ¨] --> B{è¿è¡Œæ¨¡å¼é€‰æ‹©}
    B --> C[AOTæ¨¡å¼]
    B --> D[AOT VMæ¨¡å¼] 
    
    C --> C1[ç¼–è¯‘æœŸä»£ç ç”Ÿæˆ]
    C1 --> C2[é™æ€ç±»åŠ è½½]
    C2 --> C3[é«˜æ€§èƒ½è¿è¡Œ]
    
    D --> D1[è¿è¡Œæ—¶åå°„æ‰«æ]
    D1 --> D2[åŠ¨æ€ä»£ç†]
    D2 --> D3[å¼€å‘æ¨¡å¼]
`} />

### æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | AOTæ¨¡å¼ | AOT VMæ¨¡å¼ |
|------|---------|------------|
| **ç¼–è¯‘æœŸä¼˜åŒ–** | âœ… å®Œå…¨é™æ€ç”Ÿæˆ | âŒ è¿è¡Œæ—¶å¤„ç† |
| **å¯åŠ¨æ€§èƒ½** | ğŸš€ æ¯«ç§’çº§å¯åŠ¨ | âš¡ å¿«é€Ÿå¯åŠ¨ |
| **è¿è¡Œæ€§èƒ½** | ğŸš€ æœ€ä¼˜ | âš¡ è‰¯å¥½ |
| **å¼€å‘ä½“éªŒ** | ğŸ”§ éœ€é‡ç¼–è¯‘ | ğŸ”„ æ”¯æŒçƒ­é‡è½½ |
| **é€‚ç”¨åœºæ™¯** | ğŸ­ ç”Ÿäº§ç¯å¢ƒ | ğŸ§ª å¼€å‘æµ‹è¯• |

## æ³¨è§£å¤„ç†æœºåˆ¶

AOTç¼–è¯‘çš„æ ¸å¿ƒæ˜¯`FeatAnnotationProcessor`ï¼Œå®ƒåŸºäºJava APTæŠ€æœ¯åœ¨ç¼–è¯‘æœŸæ‰«æå’Œå¤„ç†æ³¨è§£ï¼š

<Mermaid code={`
sequenceDiagram
    participant Compiler as Javaç¼–è¯‘å™¨
    participant Processor as FeatAnnotationProcessor
    participant Generator as ä»£ç ç”Ÿæˆå™¨
    participant File as ç›®æ ‡æ–‡ä»¶
    
    Compiler->>Processor: è°ƒç”¨processæ–¹æ³•
    Processor->>Processor: æ‰«æ@Controllerã€@Beanç­‰æ³¨è§£
    
    loop å¤„ç†æ¯ä¸ªæ³¨è§£å…ƒç´ 
        Processor->>Generator: åˆ›å»ºå¯¹åº”Serializer
        Generator->>File: ç”ŸæˆJavaä»£ç 
    end
    
    Processor->>File: ç”ŸæˆSPIé…ç½®æ–‡ä»¶
`} />

### æ”¯æŒçš„æ³¨è§£ç±»å‹

å®é™…çš„æ³¨è§£å¤„ç†å™¨æ”¯æŒä»¥ä¸‹æ³¨è§£ï¼š

```java
@Override
public Set<String> getSupportedAnnotationTypes() {
    Set<String> types = new HashSet<>();
    types.add(Bean.class.getCanonicalName());        // Beanç®¡ç†
    types.add(Autowired.class.getCanonicalName());   // ä¾èµ–æ³¨å…¥
    types.add(Controller.class.getCanonicalName());  // Webæ§åˆ¶å™¨
    types.add(Mapper.class.getCanonicalName());      // æ•°æ®è®¿é—®å±‚
    types.add(McpEndpoint.class.getCanonicalName()); // MCPåè®®ç«¯ç‚¹
    return types;
}
```

è¿™äº›æ³¨è§£ä¼šåœ¨ç¼–è¯‘æœŸè¢«æ‰«æï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„åˆå§‹åŒ–ä»£ç ã€‚

## ä»£ç ç”Ÿæˆä½“ç³»

Featé‡‡ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼è®¾è®¡äº†åºåˆ—åŒ–å™¨ä½“ç³»ï¼š

<Mermaid code={`
classDiagram
    class Serializer {
        +serializeLoadBean()
        +serializeAutowired()
        +serializeRouter()
        +order() int
    }
    
    class ControllerSerializer {
        +serializeRouter()
        +order() 100
    }
    
    class BeanSerializer {
        +serializeLoadBean()
        +serializeAutowired()
        +order() 200
    }
    
    class MapperSerializer {
        +serializeLoadBean()
        +order() 300
    }
    
    Serializer <|-- ControllerSerializer
    Serializer <|-- BeanSerializer
    Serializer <|-- MapperSerializer
`} />

### ä¼˜åŒ–ç­–ç•¥

1. **æ­»ä»£ç æ¶ˆé™¤**ï¼šåˆ†æä¾èµ–å…³ç³»ï¼Œåªç”Ÿæˆå®é™…ä½¿ç”¨çš„ä»£ç 
2. **å†…è”ä¼˜åŒ–**ï¼šå°†ç®€å•çš„æ–¹æ³•è°ƒç”¨ç›´æ¥å†…è”åˆ°ç”Ÿæˆä»£ç ä¸­
3. **ç±»å‹ç‰¹åŒ–**ï¼šé’ˆå¯¹å…·ä½“ç±»å‹ç”Ÿæˆä¼˜åŒ–çš„åºåˆ—åŒ–ä»£ç 

## å®é™…ä»£ç è½¬æ¢ç¤ºä¾‹

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªçœŸå®çš„ç¤ºä¾‹æ¥çœ‹AOTç¼–è¯‘çš„ä»£ç è½¬æ¢è¿‡ç¨‹ï¼š

<Tabs>
    <TabItem label="æºä»£ç ">
        ```java title="Demo2Controller.java"
        @Controller("demo2")
        public class Demo2Controller {
            
            @RequestMapping("/param1")
            public String test2(@Param("param") String param) {
                return "hello " + param;
            }
            
            @RequestMapping("/param3")
            public String test4(TestParam param) {
                return "hello " + param.getParam1() + " " + param.getParam2();
            }
        }
        ```
    </TabItem>
    
    <TabItem label="ç”Ÿæˆä»£ç ">
        ```java title="Demo2ControllerCloudService.java"
        /**
         * Copyright (c) 2022-2025 smartboot.tech All Rights Reserved.
         * @Author: ä¸‰åˆ€ zhengjunweimail@163.com
         */
        public class Demo2ControllerCloudService extends AbstractCloudService {
            private Demo2Controller bean;
            
            public void loadBean(ApplicationContext applicationContext) throws Throwable {
                bean = new Demo2Controller(); // ç›´æ¥å®ä¾‹åŒ–ï¼Œæ— åå°„
            }
            
            public void router(ApplicationContext applicationContext, Router router) {
                // ç”Ÿæˆè·¯ç”±æ˜ å°„ä»£ç 
                router.route("/demo2/param1", ctx -> {
                    JSONObject jsonObject = getParams(ctx.Request);
                    String param0 = jsonObject.getObject("param", String.class);
                    String rst = bean.test2(param0);
                    byte[] bytes = rst.getBytes("UTF-8");
                    ctx.Response.setContentLength(bytes.length);
                    ctx.Response.write(bytes);
                });
                
                router.route("/demo2/param3", ctx -> {
                    JSONObject jsonObject = getParams(ctx.Request);
                    TestParam param0 = jsonObject.to(TestParam.class);
                    String rst = bean.test4(param0);
                    byte[] bytes = rst.getBytes("UTF-8");
                    ctx.Response.setContentLength(bytes.length);
                    ctx.Response.write(bytes);
                });
            }
        }
        ```
    </TabItem>
</Tabs>

### å…³é”®ä¼˜åŒ–ç‚¹

1. **é›¶åå°„Beanå®ä¾‹åŒ–**ï¼šç›´æ¥ç”Ÿæˆ`new Demo2Controller()`è°ƒç”¨
2. **é›¶åå°„ä¾èµ–æ³¨å…¥**ï¼šç›´æ¥ç”ŸæˆBeanè·å–å’Œè®¾ç½®ä»£ç 
3. **é¢„ç¼–è¯‘è·¯ç”±**ï¼šç¼–è¯‘æœŸç”Ÿæˆå®Œæ•´çš„è·¯ç”±å¤„ç†é€»è¾‘
4. **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æœŸç¡®å®šå‚æ•°ç±»å‹ï¼Œé¿å…è¿è¡Œæ—¶ç±»å‹è½¬æ¢
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šç”Ÿæˆä¸“ç”¨çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä»£ç 

## SPIæœåŠ¡å‘ç°

ç”Ÿæˆçš„æœåŠ¡ç±»é€šè¿‡Java SPIæœºåˆ¶è¿›è¡ŒåŠ è½½ï¼š

<Mermaid code={`
graph LR
    A[ç¼–è¯‘æœŸ] --> B[ç”ŸæˆCloudServiceå®ç°]
    B --> C[åˆ›å»ºSPIé…ç½®æ–‡ä»¶]
    C --> D[META-INF/services/CloudService]
    
    E[è¿è¡ŒæœŸ] --> F[ServiceLoader.load]
    F --> G[åŠ è½½æ‰€æœ‰CloudService]
    G --> H[æŒ‰orderæ’åº]
    H --> I[ä¾æ¬¡æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ]
`} />

## AOT VMæ¨¡å¼è¯¦è§£

AOT VMæ¨¡å¼ä¸“ä¸ºå¼€å‘é˜¶æ®µè®¾è®¡ï¼Œé€šè¿‡`AotVMCloudService`åœ¨è¿è¡Œæ—¶æ¨¡æ‹ŸAOTç¼–è¯‘è¡Œä¸ºï¼š

<Mermaid code={`
flowchart TD
    A[AotVMCloudServiceå¯åŠ¨] --> B[æ‰«æç±»è·¯å¾„]
    B --> C{å‘ç°æ³¨è§£ç±»?}
    C -->|"@Controller"| D[åˆ›å»ºControllerå®ä¾‹]
    C -->|"@Bean"| E[åˆ›å»ºBeanå®ä¾‹]
    
    D --> F[åå°„è§£ææ–¹æ³•]
    E --> F
    F --> G[åŠ¨æ€è·¯ç”±æ³¨å†Œ]
    G --> H[è¿è¡Œæ—¶è¯·æ±‚å¤„ç†]
`} />

### å®é™…ä½¿ç”¨ç¤ºä¾‹

```java title="NoneAotCloudServiceTest.java"
// åˆ›å»ºAOT VMæœåŠ¡
AotVMCloudService noneAotService = new AotVMCloudService();

// é…ç½®åŒ…æ‰«æè·¯å¾„
CloudOptions options = new CloudOptions();
options.setPackages("tech.smartboot.feat.cloud.test");
ApplicationContext context = new ApplicationContext(options);

// æ‰‹åŠ¨æ‰§è¡ŒæœåŠ¡åˆå§‹åŒ–æµç¨‹
noneAotService.loadBean(context);
noneAotService.autowired(context);
noneAotService.postConstruct(context);
noneAotService.router(context, router);
```

## ç”Ÿå‘½å‘¨æœŸç®¡ç†

ä¸¤ç§æ¨¡å¼éƒ½éµå¾ªç›¸åŒçš„Beanç”Ÿå‘½å‘¨æœŸç®¡ç†è§„èŒƒï¼š

<Mermaid code={`
stateDiagram-v2
    [*] --> åˆ›å»ºå®ä¾‹: loadBean()
    åˆ›å»ºå®ä¾‹ --> å±æ€§æ³¨å…¥: autowired()
    å±æ€§æ³¨å…¥ --> åˆå§‹åŒ–: postConstruct()
    åˆå§‹åŒ– --> è·¯ç”±æ³¨å†Œ: router()
    è·¯ç”±æ³¨å†Œ --> è¿è¡Œä¸­: æœåŠ¡å°±ç»ª
    è¿è¡Œä¸­ --> é”€æ¯: destroy()
    é”€æ¯ --> [*]: åº”ç”¨å…³é—­
    
    note right of åˆ›å»ºå®ä¾‹
        AOT: é™æ€newå®ä¾‹
        VM: åå°„åˆ›å»ºå®ä¾‹
    end note
    
    note right of å±æ€§æ³¨å…¥
        AOT: ç›´æ¥setterè°ƒç”¨
        VM: åå°„å­—æ®µæ³¨å…¥
    end note
    
    note right of è·¯ç”±æ³¨å†Œ
        AOT: é¢„ç”Ÿæˆè·¯ç”±ä»£ç 
        VM: åå°„è§£æ@RequestMapping
    end note
`} />


## å®æˆ˜å»ºè®®

Featæ¡†æ¶é€šè¿‡AOTç¼–è¯‘å’ŒAOT VMåŒæ¨¡å¼è®¾è®¡ï¼Œä¸ºä¸åŒåœºæ™¯æä¾›äº†æœ€ä¼˜è§£å†³æ–¹æ¡ˆï¼š

### å¼€å‘é˜¶æ®µ

- ä½¿ç”¨AOT VMæ¨¡å¼ï¼ˆ`feat-cloud-aot-vm`ä¾èµ–ï¼‰
- æ”¯æŒçƒ­é‡è½½å’Œå¿«é€Ÿè°ƒè¯•
- æ— éœ€é‡ç¼–è¯‘å³å¯çœ‹åˆ°ä»£ç æ›´æ”¹æ•ˆæœ

### ç”Ÿäº§éƒ¨ç½²

- ä½¿ç”¨AOTæ¨¡å¼ï¼ˆ`feat-cloud-starter`ä¾èµ–ï¼‰
- è·å¾—æœ€ä½³çš„å¯åŠ¨æ€§èƒ½å’Œè¿è¡Œæ•ˆç‡
- é€‚åˆå®¹å™¨åŒ–å’Œäº‘åŸç”Ÿéƒ¨ç½²

### æ¨¡å¼åˆ‡æ¢

åœ¨Mavenä¸­é€šè¿‡ä¸åŒçš„ä¾èµ–æ¥åˆ‡æ¢æ¨¡å¼ï¼š

```xml
<!-- å¼€å‘æ¨¡å¼ -->
<dependency>
    <groupId>tech.smartboot.feat</groupId>
    <artifactId>feat-cloud-aot-vm</artifactId>
    <version>${feat.version}</version>
</dependency>

<!-- ç”Ÿäº§æ¨¡å¼ -->
<dependency>
    <groupId>tech.smartboot.feat</groupId>
    <artifactId>feat-cloud-starter</artifactId>
    <version>${feat.version}</version>
</dependency>
```

<Aside type="tip">
**å®æˆ˜å»ºè®®**ï¼šå¼€å‘æ—¶ä½¿ç”¨AOT VMæ¨¡å¼æé«˜è°ƒè¯•æ•ˆç‡ï¼Œéƒ¨ç½²æ—¶åˆ‡æ¢åˆ°AOTæ¨¡å¼è·å¾—æœ€ä½³æ€§èƒ½ã€‚ä¸¤ç§æ¨¡å¼çš„APIå®Œå…¨å…¼å®¹ï¼Œåˆ‡æ¢æˆæœ¬æä½ã€‚
</Aside>