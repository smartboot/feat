---
title: AOT ç¼–è¯‘åŸç†
description: æ·±åº¦è§£æFeatæ¡†æ¶AOTç¼–è¯‘æœºåˆ¶çš„æ ¸å¿ƒåŸç†
sidebar:
    order: 2
---

import CheckAuthorize from '../../../components/CheckAuthorize.astro'
import Mermaid from '../../../components/Mermaid.astro'
import { TabItem, Tabs, Aside } from "@astrojs/starlight/components";

<CheckAuthorize/>

## AOTç¼–è¯‘æ ¸å¿ƒåŸç†

Featæ¡†æ¶é€šè¿‡AOTï¼ˆAhead-of-Timeï¼‰ç¼–è¯‘æŠ€æœ¯å®ç°é›¶åå°„çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œç›¸æ¯”ä¼ ç»ŸJavaæ¡†æ¶åœ¨è¿è¡Œæ—¶çš„åå°„æ“ä½œï¼ŒFeatåœ¨ç¼–è¯‘æœŸå°±å®Œæˆäº†æ‰€æœ‰çš„ä»£ç ç”Ÿæˆå’Œä¼˜åŒ–å·¥ä½œã€‚

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | Spring Boot | Feat Cloud | æ€§èƒ½æå‡ |
|------|-------------|------------|----------|
| **å¯åŠ¨æ—¶é—´** | 3-10ç§’ | \<100ms | **30-100å€** |
| **å†…å­˜å ç”¨** | 200-500MB | 50-100MB | **4-5å€** |
| **åå°„å¼€é”€** | é«˜ | æ—  | **é›¶å¼€é”€** |
| **GraalVMæ”¯æŒ** | å¤æ‚ | åŸç”Ÿæ”¯æŒ | **åŸç”Ÿå…¼å®¹** |

## æŠ€æœ¯æ¶æ„

Featæ¡†æ¶æä¾›äº†ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š

<Mermaid code={`
graph TD
    A[Featåº”ç”¨å¯åŠ¨] --> B{è¿è¡Œæ¨¡å¼é€‰æ‹©}
    B --> C[AOTæ¨¡å¼]
    B --> D[AOT VMæ¨¡å¼] 
    
    C --> C1[ç¼–è¯‘æœŸä»£ç ç”Ÿæˆ]
    C1 --> C2[é™æ€ç±»åŠ è½½]
    C2 --> C3[é«˜æ€§èƒ½è¿è¡Œ]
    
    D --> D1[è¿è¡Œæ—¶åå°„æ‰«æ]
    D1 --> D2[åŠ¨æ€ä»£ç†]
    D2 --> D3[å¼€å‘æ¨¡å¼]
`} />

### æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | AOTæ¨¡å¼ | AOT VMæ¨¡å¼ |
|------|---------|------------|
| **ç¼–è¯‘æœŸä¼˜åŒ–** | âœ… å®Œå…¨é™æ€ç”Ÿæˆ | âŒ è¿è¡Œæ—¶å¤„ç† |
| **å¯åŠ¨æ€§èƒ½** | ğŸš€ æå¿«ï¼ˆ\<100msï¼‰ | âš¡ ä¸­ç­‰ |
| **è¿è¡Œæ€§èƒ½** | ğŸš€ æœ€ä¼˜ | âš¡ è‰¯å¥½ |
| **å¼€å‘ä½“éªŒ** | ğŸ”§ éœ€é‡ç¼–è¯‘ | ğŸ”„ çƒ­é‡è½½ |
| **é€‚ç”¨åœºæ™¯** | ğŸ­ ç”Ÿäº§ç¯å¢ƒ | ğŸ§ª å¼€å‘æµ‹è¯• |

## æ³¨è§£å¤„ç†æœºåˆ¶

AOTç¼–è¯‘çš„æ ¸å¿ƒæ˜¯`FeatAnnotationProcessor`ï¼Œå®ƒåŸºäºJava APTæŠ€æœ¯åœ¨ç¼–è¯‘æœŸæ‰«æå’Œå¤„ç†æ³¨è§£ï¼š

<Mermaid code={`
sequenceDiagram
    participant Compiler as Javaç¼–è¯‘å™¨
    participant Processor as FeatAnnotationProcessor
    participant Generator as ä»£ç ç”Ÿæˆå™¨
    participant File as ç›®æ ‡æ–‡ä»¶
    
    Compiler->>Processor: è°ƒç”¨processæ–¹æ³•
    Processor->>Processor: æ‰«æ@Controllerã€@Beanç­‰æ³¨è§£
    
    loop å¤„ç†æ¯ä¸ªæ³¨è§£å…ƒç´ 
        Processor->>Generator: åˆ›å»ºå¯¹åº”Serializer
        Generator->>File: ç”ŸæˆJavaä»£ç 
    end
    
    Processor->>File: ç”ŸæˆSPIé…ç½®æ–‡ä»¶
`} />

### æ”¯æŒçš„æ³¨è§£ç±»å‹

```java
@Override
public Set<String> getSupportedAnnotationTypes() {
    Set<String> types = new HashSet<>();
    types.add(Bean.class.getCanonicalName());        // Beanç®¡ç†
    types.add(Autowired.class.getCanonicalName());   // ä¾èµ–æ³¨å…¥
    types.add(Controller.class.getCanonicalName());  // Webæ§åˆ¶å™¨
    types.add(Mapper.class.getCanonicalName());      // æ•°æ®è®¿é—®å±‚
    types.add(McpEndpoint.class.getCanonicalName()); // MCPåè®®ç«¯ç‚¹
    return types;
}
```

## ä»£ç ç”Ÿæˆä½“ç³»

Featé‡‡ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼è®¾è®¡äº†åºåˆ—åŒ–å™¨ä½“ç³»ï¼š

<Mermaid code={`
classDiagram
    class Serializer {
        +serializeLoadBean()
        +serializeAutowired()
        +serializeRouter()
        +order() int
    }
    
    class ControllerSerializer {
        +serializeRouter()
        +order() 100
    }
    
    class BeanSerializer {
        +serializeLoadBean()
        +serializeAutowired()
        +order() 200
    }
    
    class MapperSerializer {
        +serializeLoadBean()
        +order() 300
    }
    
    Serializer <|-- ControllerSerializer
    Serializer <|-- BeanSerializer
    Serializer <|-- MapperSerializer
`} />

### ä¼˜åŒ–ç­–ç•¥

1. **æ­»ä»£ç æ¶ˆé™¤**ï¼šåˆ†æä¾èµ–å…³ç³»ï¼Œåªç”Ÿæˆå®é™…ä½¿ç”¨çš„ä»£ç 
2. **å†…è”ä¼˜åŒ–**ï¼šå°†ç®€å•çš„æ–¹æ³•è°ƒç”¨ç›´æ¥å†…è”åˆ°ç”Ÿæˆä»£ç ä¸­
3. **ç±»å‹ç‰¹åŒ–**ï¼šé’ˆå¯¹å…·ä½“ç±»å‹ç”Ÿæˆä¼˜åŒ–çš„åºåˆ—åŒ–ä»£ç 

## ä»£ç è½¬æ¢ç¤ºä¾‹

ä»¥Controllerä¸ºä¾‹ï¼Œå±•ç¤ºAOTç¼–è¯‘çš„ä»£ç è½¬æ¢è¿‡ç¨‹ï¼š

<Tabs>
    <TabItem label="æºä»£ç ">
        ```java title="UserController.java"
        @Controller("api")
        public class UserController {
            @Autowired
            private UserService userService;
            
            @RequestMapping("/users/:id")
            public User getUser(@PathParam("id") Long id) {
                return userService.getUserById(id);
            }
        }
        ```
    </TabItem>
    
    <TabItem label="ç”Ÿæˆä»£ç ">
        ```java title="UserControllerCloudService.java"
        public class UserControllerCloudService extends AbstractCloudService {
            private UserController bean;
            
            public void loadBean(ApplicationContext applicationContext) throws Throwable {
                bean = new UserController(); // ç›´æ¥newï¼Œæ— åå°„
            }
            
            public void autowired(ApplicationContext applicationContext) throws Throwable {
                // ç›´æ¥è°ƒç”¨setteræ–¹æ³•ï¼Œé¿å…åå°„
                bean.setUserService(applicationContext.getBean("userService"));
            }
            
            public void router(ApplicationContext applicationContext, Router router) {
                router.route("/api/users/:id", ctx -> {
                    Long id = Long.valueOf(ctx.pathParam("id"));
                    User result = bean.getUser(id);
                    
                    // ç›´æ¥åºåˆ—åŒ–å“åº”ï¼Œæ— åå°„å¼€é”€
                    byte[] bytes = JSON.toJSONString(result).getBytes("UTF-8");
                    ctx.Response.setContentType("application/json");
                    ctx.Response.write(bytes);
                });
            }
        }
        ```
    </TabItem>
</Tabs>

### å…³é”®ä¼˜åŒ–ç‚¹

1. **é›¶åå°„Beanå®ä¾‹åŒ–**ï¼šç›´æ¥ç”Ÿæˆ`new`è°ƒç”¨
2. **é›¶åå°„ä¾èµ–æ³¨å…¥**ï¼šç›´æ¥ç”Ÿæˆsetterè°ƒç”¨
3. **é¢„ç¼–è¯‘è·¯ç”±**ï¼šç¼–è¯‘æœŸç”Ÿæˆè·¯ç”±æ˜ å°„ä»£ç 
4. **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æœŸç¡®å®šå‚æ•°ç±»å‹

## SPIæœåŠ¡å‘ç°

ç”Ÿæˆçš„æœåŠ¡ç±»é€šè¿‡Java SPIæœºåˆ¶è¿›è¡ŒåŠ è½½ï¼š

<Mermaid code={`
graph LR
    A[ç¼–è¯‘æœŸ] --> B[ç”ŸæˆCloudServiceå®ç°]
    B --> C[åˆ›å»ºSPIé…ç½®æ–‡ä»¶]
    C --> D[META-INF/services/CloudService]
    
    E[è¿è¡ŒæœŸ] --> F[ServiceLoader.load]
    F --> G[åŠ è½½æ‰€æœ‰CloudService]
    G --> H[æŒ‰orderæ’åº]
    H --> I[ä¾æ¬¡æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ]
`} />

## AOT VMæ¨¡å¼

AOT VMæ¨¡å¼ä¸ºå¼€å‘é˜¶æ®µè®¾è®¡ï¼Œåœ¨è¿è¡Œæ—¶æ¨¡æ‹ŸAOTç¼–è¯‘è¡Œä¸ºï¼Œæä¾›ä¸AOTæ¨¡å¼ä¸€è‡´çš„APIä½“éªŒï¼š

<Mermaid code={`
flowchart TD
    A[AotVMCloudServiceå¯åŠ¨] --> B[æ‰«æç±»è·¯å¾„]
    B --> C{å‘ç°æ³¨è§£ç±»?}
    C -->|"@Controller"| D[åˆ›å»ºControllerå®ä¾‹]
    C -->|"@Bean"| E[åˆ›å»ºBeanå®ä¾‹]
    
    D --> F[åå°„è§£ææ–¹æ³•]
    E --> F
    F --> G[åŠ¨æ€è·¯ç”±æ³¨å†Œ]
    G --> H[è¿è¡Œæ—¶è¯·æ±‚å¤„ç†]
`} />

## ç”Ÿå‘½å‘¨æœŸç®¡ç†

ä¸¤ç§æ¨¡å¼éƒ½éµå¾ªç›¸åŒçš„Beanç”Ÿå‘½å‘¨æœŸç®¡ç†è§„èŒƒï¼š

<Mermaid code={`
stateDiagram-v2
    [*] --> åˆ›å»ºå®ä¾‹: loadBean()
    åˆ›å»ºå®ä¾‹ --> å±æ€§æ³¨å…¥: autowired()
    å±æ€§æ³¨å…¥ --> åˆå§‹åŒ–: postConstruct()
    åˆå§‹åŒ– --> è·¯ç”±æ³¨å†Œ: router()
    è·¯ç”±æ³¨å†Œ --> è¿è¡Œä¸­: æœåŠ¡å°±ç»ª
    è¿è¡Œä¸­ --> é”€æ¯: destroy()
    é”€æ¯ --> [*]: åº”ç”¨å…³é—­
    
    note right of åˆ›å»ºå®ä¾‹
        AOT: é™æ€newå®ä¾‹
        VM: åå°„åˆ›å»ºå®ä¾‹
    end note
    
    note right of å±æ€§æ³¨å…¥
        AOT: ç›´æ¥setterè°ƒç”¨
        VM: åå°„å­—æ®µæ³¨å…¥
    end note
    
    note right of è·¯ç”±æ³¨å†Œ
        AOT: é¢„ç”Ÿæˆè·¯ç”±ä»£ç 
        VM: åå°„è§£æ@RequestMapping
    end note
`} />


## ç»“è®º

Featæ¡†æ¶é€šè¿‡AOTç¼–è¯‘å’ŒAOT VMåŒæ¨¡å¼è®¾è®¡ï¼ŒæˆåŠŸè§£å†³äº†Javaåº”ç”¨æ€§èƒ½ä¸å¼€å‘æ•ˆç‡çš„å¹³è¡¡é—®é¢˜ã€‚AOTæ¨¡å¼é€šè¿‡ç¼–è¯‘æœŸé™æ€ä¼˜åŒ–å®ç°äº†æè‡´çš„è¿è¡Œæ€§èƒ½ï¼Œè€ŒAOT VMæ¨¡å¼åˆ™ä¿è¯äº†å¼€å‘é˜¶æ®µçš„çµæ´»æ€§å’Œè°ƒè¯•ä¾¿åˆ©æ€§ã€‚

<Aside type="tip">
**å®æˆ˜å»ºè®®**ï¼šåœ¨é¡¹ç›®åˆæœŸä½¿ç”¨AOT VMæ¨¡å¼å¿«é€Ÿå¼€å‘å’Œè°ƒè¯•ï¼Œåœ¨æ€§èƒ½æµ‹è¯•å’Œç”Ÿäº§éƒ¨ç½²é˜¶æ®µåˆ‡æ¢åˆ°AOTæ¨¡å¼ä»¥è·å¾—æœ€ä½³æ€§èƒ½è¡¨ç°ã€‚
</Aside>