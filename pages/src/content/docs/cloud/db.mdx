---
title: æ•°æ®åº“å¼€å‘ ğŸŒ
description: ä¸€æ¬¾ä¼ä¸šçº§ Web æœåŠ¡å¼€å‘æ¡†æ¶
sidebar:
    order: 5
---
import {TabItem, Tabs,Aside} from "@astrojs/starlight/components";
import CheckAuthorize from '../../../components/CheckAuthorize.astro'

<CheckAuthorize/>

Feat Cloud å·²åŒ Mybatis åšäº†ä¸€å®šç¨‹åº¦çš„é›†æˆï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ Mybatis æä¾›çš„ Mapper æ¥å£æ¥è¿›è¡Œæ•°æ®åº“çš„æ“ä½œã€‚æœ¬ç« å°†ä»‹ç»å¦‚ä½•åœ¨ Feat Cloud ä¸­ä½¿ç”¨ Mybatis è¿›è¡Œæ•°æ®åº“å¼€å‘ã€‚

## é…ç½® mybatis-config.xml
åœ¨ `src/main/resources` ç›®å½•ä¸‹åˆ›å»º `mybatis-config.xml`ï¼Œ æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <!-- å¯é€‰ï¼šé…ç½®MyBatisçš„å…¨å±€è¡Œä¸º -->
    <settings>
        <!-- å¼€å¯é©¼å³°å‘½åè‡ªåŠ¨æ˜ å°„ -->
        <setting name="mapUnderscoreToCamelCase" value="true"/>
        <!-- å¼€å¯äºŒçº§ç¼“å­˜ -->
        <setting name="cacheEnabled" value="true"/>
    </settings>
    
    <!-- å¯é€‰ï¼šç±»å‹åˆ«åé…ç½® -->
    <typeAliases>
        <package name="org.smartboot.feat.demo.model"/>
    </typeAliases>
    
    <!-- å¯é€‰ï¼šæ’ä»¶é…ç½® -->
    <plugins>
        <!-- åˆ†é¡µæ’ä»¶ç¤ºä¾‹ -->
        <plugin interceptor="com.github.pagehelper.PageInterceptor">
            <property name="helperDialect" value="mysql"/>
        </plugin>
    </plugins>
    
    <!-- å¿…é€‰ï¼šç¯å¢ƒé…ç½® -->
    <environments default="mysql">
        <environment id="mysql">
            <!-- ä½¿ç”¨JDBCäº‹åŠ¡ç®¡ç†å™¨ -->
            <transactionManager type="JDBC"/>
            <!-- æ•°æ®æºé…ç½® -->
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://localhost:3306/test?characterEncoding=utf-8"/>
                <property name="username" value="root"/>
                <property name="password" value="root"/>
            </dataSource>
        </environment>
    </environments>
    
    <!-- å¿…é€‰ï¼šMapperæ¥å£æ‰«æé…ç½® -->
    <mappers>
        <package name="org.smartboot.feat.demo.dao.mapper"/>
    </mappers>
</configuration>
```

<Aside type="tip">
é…ç½®æ–‡ä»¶å¯ä»¥æ”¾ç½®åœ¨ä»»æ„å­ç›®å½•ä¸‹ï¼Œä¾‹å¦‚ `src/main/resources/mybatis/mybatis-config.xml`ã€‚å»ºè®®å°†é…ç½®æ–‡ä»¶æ”¾åœ¨ä¸“é—¨çš„ç›®å½•ä¸­ä»¥ä¾¿ç®¡ç†ã€‚
</Aside>

## å®ä¾‹åŒ– SqlSessionFactory
Feat Cloud æä¾›äº†ä¸¤ç§æ–¹å¼æ¥å®ä¾‹åŒ– SqlSessionFactoryï¼š

<Tabs>
    <TabItem label="ç‹¬ç«‹çš„Beanç±»ï¼ˆæ¨èï¼‰">
    ```java
    @Bean
    public class MybatisSessionFactory {
        @Bean("sessionFactory")
        public SqlSessionFactory sessionFactory() throws IOException {
            return new SqlSessionFactoryBuilder().build(
                Resources.getResourceAsStream("mybatis/mybatis-config.xml")
            );
        }
    }
    ```
    </TabItem>

    <TabItem label="Controllerä¸­å®šä¹‰">
    ```java
    @Controller
    public class ControllerDemo {
        @Bean("sessionFactory")
        public SqlSessionFactory sessionFactory() throws IOException {
            return new SqlSessionFactoryBuilder().build(
                Resources.getResourceAsStream("mybatis/mybatis-config.xml")
            );
        }
    }
    ```
    </TabItem>
</Tabs>

<Aside type="caution">
   ç”Ÿæˆçš„ SqlSessionFactory å¯¹è±¡ bean åç§°å¿…é¡»ä¸º **sessionFactory**ã€‚è¿™æ˜¯ Feat Cloud çº¦å®šçš„å›ºå®šåç§°ã€‚
</Aside>

## å®šä¹‰@Mapperæ¥å£
@Mapper æ¥å£çš„å®šä¹‰æ–¹å¼ä¸ Spring åŸºæœ¬ä¸€è‡´ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¸¸ç”¨çš„ SQL æ“ä½œå’ŒåŠ¨æ€ SQL çš„ä½¿ç”¨ï¼š

```java title="UserMapper.java"
@Mapper
public interface UserMapper {
    // åŠ¨æ€SQLæŸ¥è¯¢ç¤ºä¾‹
    @Select({"<script>",
            "SELECT * FROM user_info",
            "<where>",
            "    <if test='username != null'>AND username LIKE CONCAT('%', #{username}, '%')</if>",
            "    <if test='role != null'>AND role = #{role}</if>",
            "</where>",
            "ORDER BY username",
            "</script>"})
    @ResultType(UserDO.class)
    List<UserDO> getUserList(UserQuery query);

    // åŸºæœ¬æŸ¥è¯¢ç¤ºä¾‹
    @Select("SELECT * FROM user_info WHERE username=#{username} AND password=#{password}")
    @ResultType(UserDO.class)
    UserDO getUser(@Param("username") String username, @Param("password") String password);

    // æ’å…¥ç¤ºä¾‹
    @Insert("INSERT INTO user_info(username,password,role,`desc`) "
         + "VALUES(#{username},#{password},#{role},#{desc})")
    @Options(useGeneratedKeys = true, keyProperty = "id")
    void insert(UserDO userDO);

    // æ‰¹é‡åˆ é™¤ç¤ºä¾‹
    @Delete("<script>"
         + "DELETE FROM user_info WHERE username IN"
         + "<foreach collection='users' item='username' open='(' close=')' separator=','>" 
         + "    #{username}"
         + "</foreach>"
         + "</script>")
    int deleteUsers(@Param("users") List<String> usernames);

    // æ›´æ–°ç¤ºä¾‹
    @Update("UPDATE user_info SET password=#{password}, role=#{role} "
         + "WHERE username=#{username}")
    int updateUser(UserDO user);
}
```

## ä½¿ç”¨@Mapperå’Œäº‹åŠ¡ç®¡ç†
Mapper æ¥å£å¯ä»¥é€šè¿‡ `@Autowired` æ³¨è§£æ³¨å…¥åˆ°å…¶ä»– Bean ä¸­ä½¿ç”¨ã€‚åŒæ—¶ï¼ŒFeat Cloud ä¹Ÿæ”¯æŒä½¿ç”¨ `@Transactional` æ³¨è§£è¿›è¡Œäº‹åŠ¡ç®¡ç†ï¼š

```java title="UserService.java"
@Service
public class UserService {
    @Autowired
    private UserMapper userMapper;

    // ä½¿ç”¨äº‹åŠ¡æ³¨è§£
    @Transactional
    public void createUser(UserDO user) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        UserDO existingUser = userMapper.getUser(user.getUsername(), null);
        if (existingUser != null) {
            throw new RuntimeException("ç”¨æˆ·å·²å­˜åœ¨");
        }
        // åˆ›å»ºæ–°ç”¨æˆ·
        userMapper.insert(user);
    }

    // æ‰¹é‡æ“ä½œç¤ºä¾‹
    @Transactional
    public void batchUpdateUsers(List<UserDO> users) {
        for (UserDO user : users) {
            userMapper.updateUser(user);
        }
    }
}
```

<Aside type="tip">
`@Transactional` æ³¨è§£æ”¯æŒé…ç½®äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºã€éš”ç¦»çº§åˆ«ã€è¶…æ—¶æ—¶é—´ç­‰å±æ€§ï¼š

- `propagation`ï¼šäº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼ˆé»˜è®¤REQUIREDï¼‰
- `isolation`ï¼šäº‹åŠ¡éš”ç¦»çº§åˆ«
- `timeout`ï¼šäº‹åŠ¡è¶…æ—¶æ—¶é—´
- `readOnly`ï¼šæ˜¯å¦ä¸ºåªè¯»äº‹åŠ¡
- `rollbackFor`ï¼šè§¦å‘å›æ»šçš„å¼‚å¸¸ç±»
</Aside>