---
title: 2.4 Https æœåŠ¡ ğŸ”
description: Feat Https
sidebar:
    order: 4
---
import https_1 from './img/https_1.png';
import CheckAuthorize from '../../../components/CheckAuthorize.astro'

<CheckAuthorize/>
å‡ºäºå®‰å…¨æœåŠ¡éœ€è¦ï¼Œç”Ÿäº§ç¯å¢ƒé€šå¸¸ä½¿ç”¨ Https åè®®ï¼ŒFeat ä¹Ÿæä¾›äº†ç›¸åº”çš„èƒ½åŠ›ã€‚

ä¸‹æ–‡æ¼”ç¤ºæ‰€ä½¿ç”¨çš„è¯ä¹¦æ˜¯é€šè¿‡ [mkcert](https://github.com/FiloSottile/mkcert) ç”Ÿæˆçš„è‡ªç­¾åè¯ä¹¦ã€‚

## 2.4.1 ç”Ÿæˆ PEM è¯ä¹¦
æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆè¯ä¹¦ï¼š
```shell
mkcert example.com "*.example.com" example.test localhost 127.0.0.1 ::1
```
å¦‚æœæ§åˆ¶å°å‡ºç°ä»¥ä¸‹æç¤ºä¿¡æ¯ï¼Œåˆ™è¡¨ç¤ºè¯ä¹¦ç”ŸæˆæˆåŠŸã€‚
```shell
Created a new certificate valid for the following names ğŸ“œ
 - "example.com"
 - "*.example.com"
 - "example.test"
 - "localhost"
 - "127.0.0.1"
 - "::1"

Reminder: X.509 wildcards only go one level deep, so this won't match a.b.example.com â„¹ï¸

The certificate is at "./example.com+5.pem" and the key at "./example.com+5-key.pem" âœ…

It will expire on 30 April 2027
```
## 2.4.2 å¯åŠ¨HttpsæœåŠ¡
å°†è¯ä¹¦æ–‡ä»¶ `example.com+5.pem` å’Œ `example.com+5-key.pem` æ‹·è´åˆ°é¡¹ç›®çš„ `src/main/resources` ç›®å½•ä¸‹ã€‚

ä½¿ç”¨ smart-socket æä¾›çš„ SslPlugin æ’ä»¶å¯åŠ¨ Https æœåŠ¡ã€‚
```java title="HttpsPemDemo.java" "new SslPlugin(new PemServerSSLContextFactory(certPem, keyPem))"
public class HttpsPemDemo {
    public static void main(String[] args) throws Exception {
        InputStream certPem = HttpsPemDemo.class.getClassLoader().getResourceAsStream("example.org.pem");
        InputStream keyPem = HttpsPemDemo.class.getClassLoader().getResourceAsStream("example.org-key.pem");
        SslPlugin sslPlugin = new SslPlugin(new PemServerSSLContextFactory(certPem, keyPem));
        Feat.httpServer(opt -> opt.addPlugin(sslPlugin)).httpHandler(req -> {
            req.getResponse().write("Hello Feat Https");
        }).listen();
    }
}
```
æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®ï¼šhttps://localhost:8080 ï¼Œè‹¥é¡µé¢å±•ç¤ºå¦‚ä¸‹ï¼Œè¯´æ˜ Https æœåŠ¡å¯åŠ¨æˆåŠŸã€‚
<img src={https_1.src} alt="hello world" width="60%" className="shadow"/>


## 2.4.3 SSLEngine ä¼ é€’
HttpRequest ä¸­æä¾›äº† `getSslEngine()` æ–¹æ³•ï¼Œç”¨äºè·å– SSLEngineã€‚

ä½†æ˜¯ï¼ŒSSLEngine æ˜¯åœ¨åº•å±‚çš„ç½‘ç»œé€šä¿¡å±‚åˆ›å»ºçš„ï¼Œåº”ç”¨å±‚æ— æ³•æ„ŸçŸ¥åº•å±‚æ˜¯å¦ä½¿ç”¨äº† SSL åè®®ã€‚
æ‰€ä»¥ï¼Œé»˜è®¤æƒ…å†µä¸‹è°ƒç”¨ `getSslEngine()` æ–¹æ³•è·å–åˆ°çš„ SSLEngine ä¸º nullã€‚

è‹¥éœ€è¦è·å– SSLEngineï¼Œå¿…é¡»åœ¨ SslPlugin ä¸­é…ç½®ï¼š **Consumer\<SSLEngine\>**ï¼Œ
å°† `SSLEngine` æ³¨å…¥åˆ° ThreadLocal ä¸­ä»¥ä¾›åº”ç”¨å±‚è·å–ã€‚
```java title=HttpsSSLEngineDemo.java {6,7}
public class HttpsSSLEngineDemo {
    public static void main(String[] args) throws Exception {
        InputStream certPem = HttpsSSLEngineDemo.class.getClassLoader().getResourceAsStream("example.com+5.pem");
        InputStream keyPem = HttpsSSLEngineDemo.class.getClassLoader().getResourceAsStream("example.com+5-key.pem");
        SslPlugin sslPlugin = new SslPlugin(new PemServerSSLContextFactory(certPem, keyPem), (Consumer<SSLEngine>) sslEngine -> {
            sslEngine.setUseClientMode(false);
            HttpRequest.SSL_ENGINE_THREAD_LOCAL.set(sslEngine);
        });
        Feat.httpServer(opt -> opt.addPlugin(sslPlugin)).httpHandler(req -> {
            SSLEngine engine = req.getSslEngine();
            if (engine == null) {
                req.getResponse().write("engine is null");
            } else {
                req.getResponse().write("engine=" + engine);
            }
        }).listen();
    }
}
```
TCP è¿æ¥å»ºç«‹æˆåŠŸåï¼Œåº”ç”¨å±‚`Endpoint.java`ä¼šåœ¨ç¬¬ä¸€æ—¶é—´è·å– `SSLEngine`ã€‚
```java title=Endpoint.java {4-6}
protected Endpoint(AioSession aioSession, ServerOptions options) {
    this.aioSession = aioSession;
    this.options = options;
    this.sslEngine = HttpRequest.SSL_ENGINE_THREAD_LOCAL.get();
    if (sslEngine != null) {
        HttpRequest.SSL_ENGINE_THREAD_LOCAL.remove();
    }
}
```