---
title: 2.2 Router è·¯ç”±ç»„ä»¶ ğŸ“Œ
description: Feat Router
sidebar:
    order: 2
---

Featä¸­çš„`Router`ç»„ä»¶æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„HTTPè¯·æ±‚åˆ†å‘å™¨ï¼Œç”¨äºå°†HTTPè¯·æ±‚åˆ†å‘åˆ°å¯¹åº”çš„å¤„ç†ç¨‹åºï¼ˆHandlerï¼‰ã€‚å®ƒæ˜¯åŸºäº`NodePath`æ ‘çŠ¶ç»“æ„å®ç°çš„ï¼Œæ”¯æŒå¤šç§è·¯ç”±åŒ¹é…æ–¹å¼ï¼ŒåŒ…æ‹¬ç²¾ç¡®åŒ¹é…ã€é€šé…ç¬¦åŒ¹é…ã€è·¯å¾„å‚æ•°åŒ¹é…ç­‰ã€‚åŒæ—¶æä¾›äº†Sessionç®¡ç†å’Œè¯·æ±‚æ‹¦æˆªç­‰é«˜çº§åŠŸèƒ½ã€‚

## 2.2.1 ä¸»è¦åŠŸèƒ½

### 1. åŸºç¡€åŠŸèƒ½

- **è·¯ç”±åŒ¹é…**ï¼šæ ¹æ®è¯·æ±‚çš„URIå°†è¯·æ±‚åˆ†å‘åˆ°å¯¹åº”çš„å¤„ç†ç¨‹åº
- **è·¯å¾„å‚æ•°æå–**ï¼šæ”¯æŒä»è·¯å¾„ä¸­æå–å‚æ•°
- **å¤šç§åŒ¹é…æ–¹å¼**ï¼šæ”¯æŒç²¾ç¡®åŒ¹é…ã€é€šé…ç¬¦åŒ¹é…ï¼ˆ`*`ï¼‰ã€è·¯å¾„å‚æ•°åŒ¹é…ï¼ˆ`:param`ï¼‰ç­‰
- **é»˜è®¤è·¯ç”±**ï¼šæœªåŒ¹é…åˆ°ä»»ä½•è·¯ç”±æ—¶ï¼Œä½¿ç”¨é»˜è®¤å¤„ç†ç¨‹åº

### 2. é«˜çº§åŠŸèƒ½

- **Sessionç®¡ç†**ï¼šæä¾›å®Œæ•´çš„Sessionç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæ”¯æŒåˆ›å»ºã€è·å–ã€æ›´æ–°å’Œé”€æ¯Session
- **è¯·æ±‚æ‹¦æˆª**ï¼šæ”¯æŒé…ç½®æ‹¦æˆªå™¨ï¼Œå®ç°è¯·æ±‚çš„å‰ç½®å’Œåç½®å¤„ç†
- **çµæ´»é…ç½®**ï¼šæ”¯æŒé“¾å¼è°ƒç”¨ï¼Œç®€åŒ–è·¯ç”±é…ç½®

## 2.2.2 è·¯ç”±åŒ¹é…åŸç†

![RouteråŸç†å›¾](./img/router.svg)

### 1. æ ¸å¿ƒæ•°æ®ç»“æ„

`Router`å†…éƒ¨é€šè¿‡`NodePath`æ ‘çŠ¶ç»“æ„å­˜å‚¨è·¯ç”±è§„åˆ™ï¼š

- **æ ¹èŠ‚ç‚¹**ï¼šè¡¨ç¤ºæ ¹è·¯å¾„`/`
- **è·¯å¾„èŠ‚ç‚¹**ï¼šæ¯ä¸ª`NodePath`èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªè·¯å¾„éƒ¨åˆ†ï¼ˆå¦‚`/user`æˆ–`:id`ï¼‰
- **å¶å­èŠ‚ç‚¹**ï¼šå­˜å‚¨å…·ä½“çš„å¤„ç†ç¨‹åºï¼ˆRouterHandlerï¼‰

### 2. åŒ¹é…æµç¨‹

1. **è§£æè¯·æ±‚URI**ï¼šå°†è¯·æ±‚URIæ‹†åˆ†ä¸ºè·¯å¾„éƒ¨åˆ†
2. **æ ‘çŠ¶åŒ¹é…**ï¼š
   - ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œé€å±‚åŒ¹é…è·¯å¾„éƒ¨åˆ†
   - ä¼˜å…ˆè¿›è¡Œç²¾ç¡®åŒ¹é…ï¼Œå…¶æ¬¡æ˜¯è·¯å¾„å‚æ•°åŒ¹é…ï¼Œæœ€åæ˜¯é€šé…ç¬¦åŒ¹é…
3. **å‚æ•°æå–**ï¼šå¦‚æœåŒ¹é…åˆ°è·¯å¾„å‚æ•°ï¼ˆå¦‚`:id`ï¼‰ï¼Œå°†å…¶æå–åˆ°`Context`ä¸­
4. **å¤„ç†ç¨‹åºè°ƒç”¨**ï¼šè°ƒç”¨åŒ¹é…åˆ°çš„å¤„ç†ç¨‹åºï¼Œå¦‚æœªåŒ¹é…åˆ™ä½¿ç”¨é»˜è®¤å¤„ç†ç¨‹åº

## 2.2.3 Sessionç®¡ç†

### 1. Sessioné…ç½®
![Sessionç®¡ç†æœºåˆ¶](./img/session.svg)
```java
Router router = new Router();
router.getSessionOptions()
      .setMaxAge(1800); // è®¾ç½®Sessionè¿‡æœŸæ—¶é—´ä¸º30åˆ†é’Ÿ
```

### 2. Sessionæ“ä½œ

```java
router.route("/session/demo", ctx -> {
    // è·å–æˆ–åˆ›å»ºSession
    Session session = ctx.getSession();
    
    // è®¾ç½®Sessionå±æ€§
    session.setAttribute("userId", "12345");
    
    // è·å–Sessionå±æ€§
    String userId = session.getAttribute("userId");
    
    // æ‰‹åŠ¨ä½¿Sessionå¤±æ•ˆ
    session.invalidate();
});
```

## 2.2.4 æ‹¦æˆªå™¨ä½¿ç”¨

![æ‹¦æˆªå™¨æ‰§è¡Œæµç¨‹](./img/interceptor.svg)

### 1. åˆ›å»ºæ‹¦æˆªå™¨

```java
public class LogInterceptor implements Interceptor {
    @Override
    public void intercept(Context ctx, Chain chain) throws Throwable {
        System.out.println("è¯·æ±‚å¼€å§‹: " + ctx.Request.getRequestURI());
        try {
            chain.proceed(ctx);
        } finally {
            System.out.println("è¯·æ±‚ç»“æŸ: " + ctx.Request.getRequestURI());
        }
    }
}
```

### 2. é…ç½®æ‹¦æˆªå™¨

```java
Router router = new Router();
// ä¸ºæ‰€æœ‰/apiè·¯å¾„ä¸‹çš„è¯·æ±‚æ·»åŠ æ‹¦æˆªå™¨
router.addInterceptor("/api/*", new LogInterceptor());

// ä¸ºå¤šä¸ªè·¯å¾„æ·»åŠ æ‹¦æˆªå™¨
List<String> patterns = Arrays.asList("/user/*", "/order/*");
router.addInterceptors(patterns, new LogInterceptor());
```

## 2.2.5 è·¯ç”±é…ç½®ç¤ºä¾‹

### 1. åŸºç¡€è·¯ç”±

```java
Router router = new Router();

// ç²¾ç¡®åŒ¹é…
router.route("/user/info", ctx -> {
    ctx.Response.write("User info");
});

// è·¯å¾„å‚æ•°åŒ¹é…
router.route("/user/:id", ctx -> {
    String id = ctx.pathParam("id");
    ctx.Response.write("User ID: " + id);
});

// é€šé…ç¬¦åŒ¹é…
router.route("/api/*", ctx -> {
    ctx.Response.write("API endpoint");
});
```

### 2. é»˜è®¤è·¯ç”±

```java
Router router = new Router(request -> {
    request.getResponse()
           .setHttpStatus(HttpStatus.NOT_FOUND)
           .write("404 Not Found");
});
```

### 3. æ·±å±‚è·¯ç”±ç¤ºä¾‹

```java
public class DeepRouterDemo {
    public static void main(String[] args) {
        Router router = new Router();

        // 1. ç²¾ç¡®åŒ¹é…ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        router.route("/api/v1/user/profile", ctx -> {
            ctx.Response.write("ç”¨æˆ·æ¡£æ¡ˆ");
        });

        // 2. è·¯å¾„å‚æ•°åŒ¹é…ï¼ˆæ¬¡é«˜ä¼˜å…ˆçº§ï¼‰
        router.route("/api/v1/user/:id/orders", ctx -> {
            String userId = ctx.pathParam("id");
            ctx.Response.write("ç”¨æˆ·" + userId + "çš„è®¢å•åˆ—è¡¨");
        });

        // 3. å¤šè·¯å¾„å‚æ•°åŒ¹é…
        router.route("/api/v1/user/:userId/orders/:orderId", ctx -> {
            String userId = ctx.pathParam("userId");
            String orderId = ctx.pathParam("orderId");
            ctx.Response.write("ç”¨æˆ·" + userId + "çš„è®¢å•" + orderId + "è¯¦æƒ…");
        });

        // 4. é€šé…ç¬¦åŒ¹é…ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰
        router.route("/api/v1/user/*", ctx -> {
            ctx.Response.write("ç”¨æˆ·ç›¸å…³API");
        });

        // 5. å¤šå±‚é€šé…ç¬¦åŒ¹é…
        router.route("/api/*/user/*/*", ctx -> {
            ctx.Response.write("é€šç”¨ç”¨æˆ·APIå¤„ç†");
        });
    }
}
```

ä¸Šè¿°ç¤ºä¾‹å±•ç¤ºäº†æ·±å±‚è·¯ç”±çš„åŒ¹é…ä¼˜å…ˆçº§è§„åˆ™ï¼š
1. ç²¾ç¡®è·¯å¾„åŒ¹é…ï¼šå®Œå…¨åŒ¹é…URLè·¯å¾„ï¼Œå¦‚`/api/v1/user/profile`
2. è·¯å¾„å‚æ•°åŒ¹é…ï¼šåŒ…å«`:param`å½¢å¼çš„å‚æ•°ï¼Œå¦‚`/api/v1/user/:id/orders`
3. é€šé…ç¬¦åŒ¹é…ï¼šåŒ…å«`*`çš„è·¯å¾„ï¼Œå¦‚`/api/v1/user/*`æˆ–`/api/*/user/*/*`

### 4. å®Œæ•´ç¤ºä¾‹

```java
public class RouterDemo {
    public static void main(String[] args) {
        Router router = new Router();
        
        // é…ç½®Session
        router.getSessionOptions().setMaxAge(1800);
        
        // æ·»åŠ æ‹¦æˆªå™¨
        router.addInterceptor("/*", new LogInterceptor());
        
        // é…ç½®è·¯ç”±
        router.route("/", ctx -> {
            Session session = ctx.getSession();
            session.setAttribute("visitTime", System.currentTimeMillis());
            ctx.Response.write("Welcome!");
        });
        
        router.route("/user/:id", ctx -> {
            String id = ctx.pathParam("id");
            Session session = ctx.getSession(false); // è·å–Sessionä½†ä¸åˆ›å»º
            if (session != null) {
                Long visitTime = session.getAttribute("visitTime");
                ctx.Response.write("User " + id + ", last visit: " + visitTime);
            } else {
                ctx.Response.write("User " + id);
            }
        });
        
        // å¯åŠ¨æœåŠ¡å™¨
        Feat.httpServer()
            .httpHandler(router)
            .listen();
    }
}
```

## 2.2.6 æ€»ç»“

Featä¸­çš„`Router`ç»„ä»¶ä¸ä»…æä¾›äº†å¼ºå¤§çš„è·¯ç”±åŒ¹é…åŠŸèƒ½ï¼Œè¿˜é›†æˆäº†Sessionç®¡ç†å’Œè¯·æ±‚æ‹¦æˆªç­‰é«˜çº§ç‰¹æ€§ã€‚é€šè¿‡æ ‘çŠ¶çš„è·¯ç”±åŒ¹é…ç»“æ„ï¼Œå®ç°äº†é«˜æ•ˆçš„è¯·æ±‚åˆ†å‘ã€‚åŒæ—¶ï¼Œå…¶é“¾å¼è°ƒç”¨çš„APIè®¾è®¡ï¼Œä½¿å¾—è·¯ç”±é…ç½®æ›´åŠ ç®€æ´ç›´è§‚ã€‚å¼€å‘è€…å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚ï¼Œçµæ´»è¿ç”¨è¿™äº›åŠŸèƒ½ï¼Œæ„å»ºåŠŸèƒ½ä¸°å¯Œçš„Webåº”ç”¨ã€‚