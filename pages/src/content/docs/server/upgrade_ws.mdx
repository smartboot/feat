---
title: 2.5 å‡çº§ WebSocket ğŸ”
description: Feat WebSocket
sidebar:
    order: 5
---

import upgrade_ws_1 from './img/upgrade_ws_1.png';
import CheckAuthorize from '../../../components/CheckAuthorize.astro'

<CheckAuthorize/>

Feat æ”¯æŒé€šè¿‡é€šè¿‡ **HttpRequest.upgrade** æ–¹æ³•å°† HTTP è¯·æ±‚å‡çº§ä¸º WebSocketã€‚

æ“ä½œç¤ºä¾‹å¦‚ä¸‹ï¼š
```java title=WebSocketDemo.java "upgrade"
public class WebSocketDemo {
    public static void main(String[] args) {
        Feat.httpServer().httpHandler(request -> {
            request.upgrade(new WebSocketUpgrade() {
                @Override
                public void handleTextMessage(WebSocketRequest request, WebSocketResponse response, String message) {
                    response.sendTextMessage("æ¥å—åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯ï¼š" + message);
                }
            });
        }).listen();
    }
}
```

å¯åŠ¨ç¨‹åºåï¼Œå¯è®¿é—®ï¼š<a target="_blank" href="http://www.websocket-test.com/">WebSocket åœ¨çº¿æµ‹è¯•</a> éªŒè¯è¿è¡Œæ•ˆæœã€‚

<img src={upgrade_ws_1.src} alt="hello world" width="80%" className="shadow"/>

## 2.5.1 æ„é€ æ–¹æ³•
WebSocketUpgrade æä¾›äº†ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š

```java
public WebSocketUpgrade() {
    this(120000);
}

public WebSocketUpgrade(long idleTimeout) {
    this.idleTimeout = idleTimeout;
}
```
ç”¨æˆ·å¯åœ¨è¿›è¡Œ WebSocket å‡çº§æ—¶ï¼Œé€šè¿‡æ„é€ æ–¹æ³•ä¼ å…¥ **idleTimeout** å‚æ•°ï¼Œè®¾ç½® WebSocket è¿æ¥çš„ç©ºé—²è¶…æ—¶æ—¶é—´ã€‚
å…¶ä¸­æ— å‚æ„é€ æ–¹æ³•é»˜è®¤è®¾ç½®ç©ºé—²è¶…æ—¶æ—¶é—´ä¸º 120000 æ¯«ç§’ï¼Œå³ï¼š2 åˆ†é’Ÿã€‚

å½“ WebSocket è¿æ¥ç©ºé—²æ—¶é—´è¶…è¿‡ **idleTimeout** æ—¶ï¼ŒFeat ä¼šä¸»åŠ¨å…³é—­è¯¥è¿æ¥ã€‚

## 2.5.2 æ¶ˆæ¯å¤„ç†
WebSocketUpgrade æä¾›äº†ä¸¤ä¸ªæ¶ˆæ¯å¤„ç†æ–¹æ³•ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š
```java
public void handle(WebSocketRequest request, WebSocketResponse response, CompletableFuture<Object> completableFuture) throws Throwable {
    try {
        handle(request, response);
    } finally {
        completableFuture.complete(null);
    }
}

public void handle(WebSocketRequest request, WebSocketResponse response) throws Throwable {
    ...
}

```
å¦‚æœç”¨æˆ·éœ€è¦é‡‡ç”¨å¼‚æ­¥æ–¹å¼å¤„ç† WebSocket æ¶ˆæ¯ï¼Œå¯é‡å†™å¸¦ `CompletableFuture<Object>` å…¥å‚çš„ **handle** æ–¹æ³•ï¼Œå¹¶åœ¨å¼‚æ­¥å¤„ç†å®Œæˆåï¼Œè°ƒç”¨ `completableFuture.complete(null)` æ–¹æ³•ã€‚

è‹¥éœ€è¦åŒæ­¥å¤„ç† WebSocket æ¶ˆæ¯ï¼Œå¯é‡å†™ `handle(WebSocketRequest request, WebSocketResponse response) ` æ–¹æ³•ã€‚

ä¸ºä¾¿äºå¼€å‘äººå‘˜ä½¿ç”¨ï¼ŒWebSocketUpgrade å·²ç»é»˜è®¤å®ç°äº† `handle(WebSocketRequest request, WebSocketResponse response)` æ–¹æ³•ï¼Œç”¨æˆ·å¯æŒ‰éœ€é‡å†™ç›¸åº”çš„æ–¹æ³•ã€‚

```java "handleTextMessage" "handleBinaryMessage" "onClose" "onError" "handlePing" "handlePong" "handleContinueMessage"
public void handle(WebSocketRequest request, WebSocketResponse response) throws Throwable {
    try {
        switch (request.getFrameOpcode()) {
            case WebSocketUtil.OPCODE_TEXT:
                handleTextMessage(request, response, new String(request.getPayload(), StandardCharsets.UTF_8));
                break;
            case WebSocketUtil.OPCODE_BINARY:
                handleBinaryMessage(request, response, request.getPayload());
                break;
            case WebSocketUtil.OPCODE_CLOSE:
                try {
                    onClose(request, response, new CloseReason(request.getPayload()));
                } finally {
                    response.close();
                }
                break;
            case WebSocketUtil.OPCODE_PING:
                handlePing(request, response);
                break;
            case WebSocketUtil.OPCODE_PONG:
                handlePong(request, response);
                break;
            case WebSocketUtil.OPCODE_CONTINUE:
                handleContinueMessage(request, response, request.getPayload());
                break;
            default:
                throw new UnsupportedOperationException();
        }
    } catch (Throwable throwable) {
        onError(request, throwable);
    }
}
```

## 2.5.3 è¯·æ±‚è·¯ç”±
åœ¨å®é™…åœºæ™¯ä¸‹ï¼Œç”¨æˆ·å¯èƒ½éœ€è¦å°†ä¸åŒçš„ WebSocket æ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„å¤„ç†æ–¹æ³•ï¼Œ
ä»¥åŠå­˜åœ¨ Http è¯·æ±‚å’Œ WebSocket è¯·æ±‚å…±å­˜çš„æƒ…å†µã€‚

æ­¤æ—¶å¯ä»¥é‡‡ç”¨ `Router` æ¥å®ç°è¯·æ±‚è·¯ç”±ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š
```java title=WebSocketRouterDemo.java 'route("/ws1"' 'route("/ws2"' 'route("/http"'
public class WebSocketRouterDemo {
    public static void main(String[] args) {
        Router router = new Router();
        router.route("/ws1", request -> {
            request.upgrade(new WebSocketUpgrade() {
                @Override
                public void handleTextMessage(WebSocketRequest request, WebSocketResponse response, String message) {
                    response.sendTextMessage("ws1æ¥å—åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯ï¼š" + message);
                }
            });
        }).route("/ws2", request -> {
            request.upgrade(new WebSocketUpgrade() {
                @Override
                public void handleTextMessage(WebSocketRequest request, WebSocketResponse response, String message) {
                    response.sendTextMessage("ws2æ¥å—åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯ï¼š" + message);
                }
            });
        }).route("/http", request -> {
            request.getResponse().write("http".getBytes());
        });
        Feat.httpServer().httpHandler(router).listen();
    }
}
```