---
title: å¼‚æ­¥å“åº” ğŸŒ
description: Feat HTTPè¯·æ±‚å¼‚æ­¥å¤„ç†æ•™ç¨‹
sidebar:
    order: 4
---
import CheckAuthorize from '../../../components/CheckAuthorize.astro'

<CheckAuthorize/>

åœ¨å¤„ç†HTTPè¯·æ±‚æ—¶ï¼Œæœ‰æ—¶éœ€è¦æ‰§è¡Œä¸€äº›è€—æ—¶çš„æ“ä½œï¼Œå¦‚æ•°æ®åº“æŸ¥è¯¢ã€è¿œç¨‹APIè°ƒç”¨æˆ–å¤æ‚è®¡ç®—ã€‚è¿™äº›æ“ä½œå¦‚æœåœ¨ä¸»çº¿ç¨‹ä¸­åŒæ­¥æ‰§è¡Œï¼Œä¼šé˜»å¡æœåŠ¡å™¨å¤„ç†å…¶ä»–è¯·æ±‚ï¼Œé™ä½ç³»ç»Ÿçš„ååé‡å’Œå“åº”èƒ½åŠ›ã€‚

Featæ¡†æ¶æä¾›äº†ç®€å•é«˜æ•ˆçš„å¼‚æ­¥å¤„ç†æœºåˆ¶ï¼Œè®©æ‚¨èƒ½å¤Ÿè½»æ¾å®ç°éé˜»å¡çš„HTTPè¯·æ±‚å¤„ç†ã€‚

## å¼‚æ­¥å¤„ç†åŸç†

Featæ¡†æ¶çš„å¼‚æ­¥å¤„ç†æœºåˆ¶åŸºäºJavaçš„`CompletableFuture`ï¼Œå®ƒå…è®¸æ‚¨å°†è¯·æ±‚å¤„ç†é€»è¾‘æ”¾åœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè€Œä¸ä¼šé˜»å¡HTTPæœåŠ¡å™¨çš„ä¸»çº¿ç¨‹ã€‚

`HttpHandler`æ¥å£æä¾›äº†ä¸¤ä¸ª`handle`æ–¹æ³•ï¼š

```java
// åŒæ­¥å¤„ç†æ–¹æ³•
void handle(HttpRequest request) throws Throwable;

// å¼‚æ­¥å¤„ç†æ–¹æ³•
default void handle(HttpRequest request, CompletableFuture<Object> completableFuture) throws Throwable {
    try {
        handle(request);
    } finally {
        completableFuture.complete(null);
    }
}
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼‚æ­¥å¤„ç†æ–¹æ³•ä¼šè°ƒç”¨åŒæ­¥å¤„ç†æ–¹æ³•ï¼Œå¹¶åœ¨å¤„ç†å®Œæˆåè‡ªåŠ¨å®Œæˆ`CompletableFuture`ã€‚ä½†æ‚¨å¯ä»¥è¦†ç›–è¿™ä¸ªé»˜è®¤å®ç°ï¼Œå®ç°çœŸæ­£çš„å¼‚æ­¥å¤„ç†ã€‚

## å®ç°å¼‚æ­¥å¤„ç†

è¦å®ç°å¼‚æ­¥å¤„ç†ï¼Œæ‚¨éœ€è¦ï¼š

1. è¦†ç›–`handle(HttpRequest request, CompletableFuture<Object> completableFuture)`æ–¹æ³•
2. åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
3. æ“ä½œå®Œæˆåæ‰‹åŠ¨è°ƒç”¨`completableFuture.complete(result)`

### ç¤ºä¾‹ä»£ç 

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„å¼‚æ­¥å¤„ç†ç¤ºä¾‹ï¼š

```java
import tech.smartboot.feat.core.server.HttpHandler;
import tech.smartboot.feat.core.server.HttpRequest;
import tech.smartboot.feat.core.server.HttpServer;

import java.io.IOException;
import java.util.Date;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

public class AsyncHttpDemo {
    public static void main(String[] args) {
        ExecutorService executorService = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());
        HttpServer bootstrap = new HttpServer();
        bootstrap.httpHandler(new HttpHandler() {

            @Override
            public void handle(HttpRequest request, CompletableFuture<Object> future) throws IOException {
                // å°†è¯·æ±‚å¤„ç†é€»è¾‘æ”¾åœ¨ç‹¬ç«‹çš„çº¿ç¨‹æ± ä¸­æ‰§è¡Œ
                executorService.execute(() -> {
                    try {
                        // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
                        Thread.sleep(1000);
                        // å¤„ç†è¯·æ±‚å¹¶å†™å…¥å“åº”
                        request.getResponse().write(("<br/>" + new Date() + " currentThread:" + Thread.currentThread()).getBytes());
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                    // æ“ä½œå®Œæˆåï¼Œæ‰‹åŠ¨å®ŒæˆCompletableFuture
                    future.complete(this);
                });
            }

            @Override
            public void handle(HttpRequest request) throws Throwable {
                // è¿™ä¸ªæ–¹æ³•åœ¨å¼‚æ­¥æ¨¡å¼ä¸‹ä¸ä¼šè¢«è°ƒç”¨
            }
        });
        bootstrap.options().debug(true);
        bootstrap.listen(8080);
    }
}
```

## å¼‚æ­¥å¤„ç†çš„ä¼˜åŠ¿

1. **æé«˜ååé‡**ï¼šä¸»çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼Œå¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–è¯·æ±‚
2. **æ›´å¥½çš„èµ„æºåˆ©ç”¨**ï¼šå¯ä»¥æ ¹æ®ç³»ç»Ÿèµ„æºæƒ…å†µè°ƒæ•´çº¿ç¨‹æ± å¤§å°
3. **æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ**ï¼šæœåŠ¡å™¨å¯ä»¥å¤„ç†æ›´å¤šå¹¶å‘è¯·æ±‚ï¼Œå‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´
4. **çµæ´»çš„å¼‚å¸¸å¤„ç†**ï¼šå¯ä»¥åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­æ•è·å¼‚å¸¸ï¼Œå¹¶é€šè¿‡`completableFuture.completeExceptionally(throwable)`ä¼ é€’å¼‚å¸¸


é€šè¿‡Featæ¡†æ¶çš„å¼‚æ­¥å¤„ç†æœºåˆ¶ï¼Œæ‚¨å¯ä»¥è½»æ¾æ„å»ºé«˜æ€§èƒ½ã€é«˜å¹¶å‘çš„Webåº”ç”¨ï¼Œå……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æºï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

